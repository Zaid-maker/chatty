name: CI ğŸš€

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: Quality Checks ğŸ”
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: ğŸ”’ Setup Snyk
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: ğŸ”’ Security audit
        run: |
          cd server && bun snyk test
          cd ../client && bun snyk test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true # Optional: prevents CI failure on security issues

      - name: ğŸ› ï¸ Install Global Dependencies
        run: bun install -g eslint prettier

      - name: ğŸ“ Lint server
        working-directory: ./server
        run: |
          bun install
          bunx eslint .

      - name: ğŸ“ Lint client
        working-directory: ./client
        run: |
          bun install
          bunx eslint .
        continue-on-error: true

      - name: ğŸ¨ Check formatting for server
        run: |
          cd server && bunx prettier --check .

      - name: ğŸ¨ Check formatting for client
        run: |
          cd ../client && bunx prettier --check .

  test:
    name: Test Suite ğŸ§ª
    runs-on: ubuntu-latest
    needs: quality

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - uses: actions/checkout@v3

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: |
          cd server && bun install
          cd ../client && bun install

      - name: ğŸ§ª Run tests
        run: |
          cd server && bun test
          cd ../client && bun test

      - name: ğŸ§ª Run tests with coverage
        run: |
          cd server && bun test --coverage
          cd ../client && bun run test:coverage

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: |
            ./server/coverage/coverage-final.json
            ./client/coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  build:
    name: Build & Deploy ğŸš€
    runs-on: ubuntu-latest
    needs: [quality, test]

    steps:
      - uses: actions/checkout@v3

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: |
          cd server && bun install
          cd ../client && bun install

      - name: ğŸ—ï¸ Build client
        working-directory: ./client
        run: bun run build

      - name: ğŸ“Š Analyze bundle size
        working-directory: ./client
        run: bun run analyze

      - name: ğŸš€ Build server
        working-directory: ./server
        run: bun run build

      - name: ğŸ“ˆ Performance check
        working-directory: ./client
        run: bun run lighthouse

      - name: ğŸ“¦ Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: |
            client/dist
            server/dist
