name: CI 🚀

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    name: Quality Checks 🔍
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: 📦 Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: 🔒 Setup Snyk
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: 🔒 Security audit
        run: |
          cd server && bun snyk test
          cd ../client && bun snyk test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true # Optional: prevents CI failure on security issues

      - name: 🛠️ Install Global Dependencies
        run: bun install -g eslint prettier

      - name: 📝 Lint server
        working-directory: ./server
        run: |
          bun install
          bunx eslint .

      - name: 📝 Lint client
        working-directory: ./client
        run: |
          bun install
          bunx eslint .
        continue-on-error: true

      - name: 🎨 Check formatting for server
        run: |
          cd server && bunx prettier --check .

      - name: 🎨 Check formatting for client
        run: |
          cd ../client && bunx prettier --check .

  test:
    name: Test Suite 🧪
    runs-on: ubuntu-latest
    needs: quality

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - uses: actions/checkout@v3

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: 📦 Install dependencies
        run: |
          cd server && bun install
          cd ../client && bun install

      - name: 🧪 Run tests
        run: |
          cd server && bun test
          cd ../client && bun test

      - name: 🧪 Run tests with coverage
        run: |
          cd server && bun test --coverage
          cd ../client && bun run test:coverage

      - name: 📊 Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: |
            ./server/coverage/coverage-final.json
            ./client/coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  build:
    name: Build & Deploy 🚀
    runs-on: ubuntu-latest
    needs: [quality, test]

    steps:
      - uses: actions/checkout@v3

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: 📦 Install dependencies
        run: |
          cd server && bun install
          cd ../client && bun install

      - name: 🏗️ Build client
        working-directory: ./client
        run: bun run build

      - name: 📊 Analyze bundle size
        working-directory: ./client
        run: bun run analyze

      - name: 🚀 Build server
        working-directory: ./server
        run: bun run build

      - name: 📈 Performance check
        working-directory: ./client
        run: bun run lighthouse

      - name: 📦 Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build
          path: |
            client/dist
            server/dist
